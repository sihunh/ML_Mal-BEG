import os
import shutil
from flask import Flask, request, render_template, jsonify
from werkzeug.utils import secure_filename
from Malware_detect_model import predict_malware  # 이전에 정의한 예측 함수를 import

app = Flask(__name__)

# 파일 업로드 설정
UPLOAD_FOLDER = 'uploads'
ANALYZED_FOLDER = 'analyzed_files'
UNCERTAIN_FOLDER = 'uncertain_files'
ALLOWED_EXTENSIONS = {'exe', 'dll', 'pdf', 'doc', 'docx', 'bin'}
CONFIDENCE_THRESHOLD = 0.7  # 이 값 이하의 신뢰도를 가진 예측은 불확실한 것으로 간주

app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route('/', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
        if 'file' not in request.files:
            return jsonify({'error': 'No file part'})
        file = request.files['file']
        if file.filename == '':
            return jsonify({'error': 'No selected file'})
        if file and allowed_file(file.filename):
            filename = secure_filename(file.filename)
            file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
            file.save(file_path)
            
            # 예측
            result, confidence = predict_malware(file_path)
            
            # 결과 저장
            os.makedirs(ANALYZED_FOLDER, exist_ok=True)
            result_str = 'Malware' if result == 1 else 'Benign'
            new_filename = f"{result_str}_{confidence:.2f}_{filename}"
            shutil.move(file_path, os.path.join(ANALYZED_FOLDER, new_filename))
            
            # 불확실한 케이스 처리
            if confidence < CONFIDENCE_THRESHOLD:
                os.makedirs(UNCERTAIN_FOLDER, exist_ok=True)
                shutil.copy(os.path.join(ANALYZED_FOLDER, new_filename), 
                            os.path.join(UNCERTAIN_FOLDER, new_filename))
            
            return jsonify({
                'result': result_str,
                'confidence': f"{confidence:.2f}"
            })
    return render_template('upload.html')

if __name__ == '__main__':
    os.makedirs(UPLOAD_FOLDER, exist_ok=True)
    app.run(debug=True)
